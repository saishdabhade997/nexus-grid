<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control | NexusGrid</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        brand: { 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                        dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        amber: { 500: '#f59e0b', 600: '#d97706' }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body { background-color: #020617; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .nav-item.active { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border-right: 2px solid #3b82f6; }
        .status-badge { @apply px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-in { animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
    
    <script>
        (function() {
            const token = localStorage.getItem('authToken');
            // Allow admin to bypass if developing, otherwise enforce role check
            // const role = localStorage.getItem('userRole'); 
            // if (!token || role !== 'admin') window.location.href = '/login.html';
            if (!token) window.location.href = '/login.html';
        })();
    </script>
</head>
<body class="text-slate-300 antialiased h-screen flex overflow-hidden selection:bg-brand-500/30">

    <aside class="w-64 bg-dark-900 border-r border-slate-800 flex flex-col justify-between hidden md:flex">
        <div>
            <div class="h-16 flex items-center px-6 border-b border-slate-800">
                <div class="w-8 h-8 bg-brand-600 rounded flex items-center justify-center text-white font-bold mr-3 shadow-lg shadow-brand-500/20">N</div>
                <span class="font-bold text-white tracking-tight">NEXUS<span class="text-brand-500">GRID</span></span>
            </div>
            
            <nav class="p-4 space-y-1">
                <button onclick="switchView('overview')" id="nav-overview" class="nav-item active w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800/50 rounded-l transition-all">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="font-medium text-sm">Client Registry</span>
                </button>
                <button onclick="switchView('devices')" id="nav-devices" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800/50 rounded-l transition-all">
                    <i data-lucide="zap" class="w-5 h-5"></i>
                    <span class="font-medium text-sm">Asset Map</span>
                </button>
            </nav>
        </div>
        <div class="p-4 border-t border-slate-800">
            <button onclick="logout()" class="flex items-center gap-3 px-4 py-2 text-slate-500 hover:text-red-400 w-full transition-colors text-sm font-medium">
                <i data-lucide="log-out" class="w-5 h-5"></i> Logout
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden">
        <header class="h-16 border-b border-slate-800 bg-dark-900/50 backdrop-blur flex items-center justify-between px-8">
            <h1 id="page-title" class="text-lg font-semibold text-white">Client Management</h1>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 px-3 py-1.5 bg-green-500/10 border border-green-500/20 rounded-full">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-xs font-bold text-green-400 uppercase tracking-wide">Grid Online</span>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 relative">
            
            <div id="view-overview" class="view-section animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="glass-panel p-5 rounded-xl border-l-4 border-brand-500">
                        <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Total Clients</h3>
                        <p id="stat-users" class="text-2xl font-bold text-white mt-1">--</p>
                    </div>
                    <div class="glass-panel p-5 rounded-xl border-l-4 border-purple-500">
                        <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Energy Flow</h3>
                        <p id="stat-energy" class="text-2xl font-bold text-white mt-1">-- <span class="text-sm font-normal text-slate-500">kWh</span></p>
                    </div>
                    <div class="glass-panel p-5 rounded-xl border-l-4 border-amber-500">
                        <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Pending Approvals</h3>
                        <p id="stat-requests" class="text-2xl font-bold text-white mt-1">0</p>
                    </div>
                    <div class="glass-panel p-5 rounded-xl flex items-center justify-between bg-brand-900/10 hover:bg-brand-900/20 transition-colors cursor-pointer" onclick="openModal('modal-create-user')">
                        <div>
                            <h3 class="text-brand-400 text-[10px] font-bold uppercase tracking-widest">Quick Action</h3>
                            <p class="text-sm font-bold text-white mt-1">Add New Client</p>
                        </div>
                        <div class="bg-brand-600 text-white p-2 rounded-lg">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl overflow-hidden shadow-2xl">
                    
                    <div class="p-0 border-b border-slate-800 bg-dark-950/30 flex justify-between items-center pr-6">
                        <div class="flex">
                            <button onclick="switchSubTab('registry')" id="subtab-registry" class="px-6 py-4 text-sm font-bold text-brand-400 border-b-2 border-brand-500 bg-brand-500/5 transition-all flex items-center gap-2">
                                <i data-lucide="list" class="w-4 h-4"></i> Client Registry
                            </button>
                            <button onclick="switchSubTab('approvals')" id="subtab-approvals" class="px-6 py-4 text-sm font-bold text-slate-500 hover:text-white border-b-2 border-transparent transition-all flex items-center gap-2">
                                <i data-lucide="inbox" class="w-4 h-4"></i> Approvals 
                                <span id="small-badge" class="hidden bg-amber-500 text-black px-1.5 py-0.5 rounded text-[9px]">0</span>
                            </button>
                        </div>
                        
                        <div class="relative hidden md:block" id="search-container">
                            <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-500"></i>
                            <input type="text" id="search-input" onkeyup="filterUsers()" placeholder="Search clients..." 
                                class="bg-dark-900 border border-slate-700 text-sm text-white rounded-lg pl-9 pr-4 py-2 w-64 focus:border-brand-500 outline-none placeholder-slate-600">
                        </div>
                    </div>

                    <table id="table-registry" class="w-full text-left">
                        <thead class="bg-dark-900/80 text-[10px] text-slate-500 uppercase font-bold tracking-wider">
                            <tr>
                                <th class="p-5 border-b border-slate-800">Client Identity</th>
                                <th class="p-5 border-b border-slate-800">Meters & Usage</th>
                                <th class="p-5 border-b border-slate-800">Financial Status</th>
                                <th class="p-5 border-b border-slate-800">Access Status</th>
                                <th class="p-5 border-b border-slate-800 text-right">Controls</th>
                            </tr>
                        </thead>
                        <tbody id="user-table" class="text-sm divide-y divide-slate-800/50"></tbody>
                    </table>

                    <table id="table-approvals" class="w-full text-left hidden">
                        <thead class="bg-dark-900/80 text-[10px] text-slate-500 uppercase font-bold tracking-wider">
                            <tr>
                                <th class="p-5 border-b border-slate-800">Request ID</th>
                                <th class="p-5 border-b border-slate-800">Client</th>
                                <th class="p-5 border-b border-slate-800">Requested Change</th>
                                <th class="p-5 border-b border-slate-800">Details</th>
                                <th class="p-5 border-b border-slate-800 text-right">Decision</th>
                            </tr>
                        </thead>
                        <tbody id="requests-table" class="text-sm divide-y divide-slate-800/50">
                            <tr><td colspan="5" class="p-10 text-center text-slate-500 italic">No pending requests found.</td></tr>
                        </tbody>
                    </table>

                </div>
            </div>

            <div id="view-devices" class="view-section hidden animate-fade-in">
                <div class="glass-panel rounded-2xl overflow-hidden shadow-2xl">
                    <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-dark-950/30">
                        <div>
                            <h2 class="text-white font-bold flex items-center gap-2"><i data-lucide="zap" class="w-4 h-4 text-yellow-500"></i> Global Asset Registry</h2>
                            <p class="text-xs text-slate-500 mt-1">Master list of all deployed hardware</p>
                        </div>
                        <button onclick="openModal('modal-assign-device')" class="bg-brand-600 hover:bg-brand-500 text-white text-xs font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-lg shadow-brand-500/20">
                            <i data-lucide="link" class="w-4 h-4"></i> Provision Meter
                        </button>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-dark-900/80 text-[10px] text-slate-500 uppercase font-bold tracking-wider">
                            <tr>
                                <th class="p-5 border-b border-slate-800">Device ID (MAC)</th>
                                <th class="p-5 border-b border-slate-800">Assigned To</th>
                                <th class="p-5 border-b border-slate-800">Status</th>
                                <th class="p-5 border-b border-slate-800 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="device-master-table" class="text-sm divide-y divide-slate-800/50"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-3"></div>

    <div id="modal-create-user" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md p-8 rounded-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Onboard New Client</h3>
                <button onclick="closeModal('modal-create-user')" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <input type="email" id="new-email" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-white mb-3 focus:border-brand-500 outline-none" placeholder="Client Email">
            <input type="text" id="new-pass" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-white mb-6 font-mono focus:border-brand-500 outline-none" placeholder="Default Password">
            <button onclick="createUser()" class="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-brand-500/20">Create Account</button>
        </div>
    </div>

    <div id="modal-assign-device" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-md p-8 rounded-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Provision Meter</h3>
                <button onclick="closeModal('modal-assign-device')" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">User ID</label>
                        <input type="number" id="assign-user-id" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-3 text-white focus:border-brand-500 outline-none text-center">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Device ID (MAC)</label>
                        <input type="text" id="assign-device-id" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-500 outline-none font-mono" placeholder="meter_01">
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Friendly Name</label>
                    <input type="text" id="assign-device-name" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-brand-500 outline-none" placeholder="e.g. Factory Line 1">
                </div>
                <button onclick="assignDevice()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition-colors shadow-lg shadow-blue-500/20 mt-2">Confirm Assignment</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let allUsers = [];

        // --- NAVIGATION ---
        function switchView(viewId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${viewId}`).classList.add('active');
            
            const titles = { 'overview': 'Client Management', 'devices': 'Asset Map' };
            document.getElementById('page-title').innerText = titles[viewId];

            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');

            if(viewId === 'devices') renderDeviceRegistry();
        }

        // --- NEW: SUB-TAB SWITCHER (REGISTRY vs APPROVALS) ---
        function switchSubTab(tab) {
            // Update Tab Styles
            document.getElementById('subtab-registry').className = tab === 'registry' 
                ? 'px-6 py-4 text-sm font-bold text-brand-400 border-b-2 border-brand-500 bg-brand-500/5 transition-all flex items-center gap-2 cursor-pointer' 
                : 'px-6 py-4 text-sm font-bold text-slate-500 hover:text-white border-b-2 border-transparent transition-all flex items-center gap-2 cursor-pointer';
            
            document.getElementById('subtab-approvals').className = tab === 'approvals' 
                ? 'px-6 py-4 text-sm font-bold text-amber-400 border-b-2 border-amber-500 bg-amber-500/5 transition-all flex items-center gap-2 cursor-pointer' 
                : 'px-6 py-4 text-sm font-bold text-slate-500 hover:text-white border-b-2 border-transparent transition-all flex items-center gap-2 cursor-pointer';

            // Show/Hide Tables & Search
            document.getElementById('table-registry').classList.toggle('hidden', tab !== 'registry');
            document.getElementById('table-approvals').classList.toggle('hidden', tab !== 'approvals');
            document.getElementById('search-container').classList.toggle('hidden', tab !== 'registry');

            if (tab === 'approvals') loadPendingRequests();
        }

        // --- DATA LOADING ---
        async function loadUsers() {
            const token = localStorage.getItem('authToken');
            try {
                const res = await fetch(`${API_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                let users = await res.json();
                
                users = users.map(u => ({
                    ...u,
                    total_units: parseFloat(u.total_units_consumed || 0),
                    bill_due: parseFloat(u.billing_due || 0),
                    is_blocked: u.is_blocked === true
                }));

                allUsers = users;
                renderUsers(allUsers);
                updateStats(allUsers);

            } catch(e) { console.error("Load Error:", e); }
        }

        // --- NEW: APPROVAL QUEUE LOGIC ---
        async function loadPendingRequests() {
            const token = localStorage.getItem('authToken');
            try {
                // Fetch Requests from Server
                const res = await fetch(`${API_URL}/admin/requests`, { headers: { 'Authorization': `Bearer ${token}` } });
                const requests = await res.json();
                
                // Update Top Stat & Tab Badge
                document.getElementById('stat-requests').innerText = requests.length;
                const badge = document.getElementById('small-badge');
                if (requests.length > 0) {
                    badge.innerText = requests.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

                renderRequestsTable(requests);
            } catch(e) { 
                console.error("Requests Load Error:", e); 
            }
        }

        function renderRequestsTable(requests) {
            const tbody = document.getElementById('requests-table');
            if(requests.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-slate-500 italic">No pending requests found.</td></tr>`;
                return;
            }

            tbody.innerHTML = requests.map(r => `
                <tr class="hover:bg-amber-500/5 transition-colors border-b border-slate-800/50">
                    <td class="p-5 font-mono text-xs text-slate-500">REQ-#${r.id}</td>
                    <td class="p-5 font-bold text-white">${r.user_email}</td>
                    <td class="p-5"><span class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-xs font-mono text-brand-300">${r.type.replace('_', ' ')}</span></td>
                    <td class="p-5"><code class="text-xs text-amber-300 bg-amber-900/20 px-2 py-1 rounded border border-amber-500/20">${JSON.stringify(r.payload)}</code></td>
                    <td class="p-5 text-right">
                        <button onclick="handleRequest(${r.id}, 'reject')" class="px-3 py-1.5 mr-2 rounded bg-red-950 text-red-400 hover:bg-red-600 hover:text-white border border-red-800 text-xs font-bold uppercase transition-all">Reject</button>
                        <button onclick="handleRequest(${r.id}, 'approve')" class="px-3 py-1.5 rounded bg-green-600 hover:bg-green-500 text-white text-xs font-bold uppercase shadow-lg shadow-green-500/20 transition-all">Approve</button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function handleRequest(id, action) {
            if(!confirm(`Confirm ${action.toUpperCase()} for Request #${id}?`)) return;
            const token = localStorage.getItem('authToken');
            
            try {
                const res = await fetch(`${API_URL}/admin/requests/${id}/${action}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if(res.ok) {
                    showToast(`Request ${action}d successfully`);
                    loadPendingRequests();
                } else {
                    showToast("Action failed", "error");
                }
            } catch(e) {
                showToast("Connection error", "error");
            }
        }

        // --- EXISTING HELPER FUNCTIONS ---
        function filterUsers() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = allUsers.filter(u => u.email.toLowerCase().includes(term) || u.id.toString().includes(term));
            renderUsers(filtered);
        }

       function updateStats(users) {
            // 1. Total Clients
            const userEl = document.getElementById('stat-users');
            if (userEl) userEl.innerText = users.length;

            // 2. Total Energy
            const totalEnergy = users.reduce((sum, u) => sum + parseFloat(u.total_units), 0);
            const energyEl = document.getElementById('stat-energy');
            if (energyEl) energyEl.innerText = (totalEnergy / 1000).toFixed(1) + ' MWh';

            // REMOVED: Debt calculation (stat-debt) because that card was replaced by "Pending Approvals"
        }

        function renderUsers(users) {
            const tbody = document.getElementById('user-table');
            if(users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-500">No records found.</td></tr>`;
                return;
            }
            tbody.innerHTML = users.map(u => {
                const isBlocked = u.is_blocked;
                const hasDebt = parseFloat(u.bill_due) > 0;
                const rowClass = isBlocked ? 'bg-red-500/5' : 'hover:bg-slate-800/30';
                
                let statusBadge = `<span class="status-badge bg-green-500/10 text-green-400 border-green-500/20">Active</span>`;
                if(isBlocked) statusBadge = `<span class="status-badge bg-red-500/10 text-red-500 border-red-500/20 animate-pulse">SUSPENDED</span>`;

                let billDisplay = `<span class="text-slate-500 text-xs font-mono">Paid</span>`;
                if(hasDebt) billDisplay = `<span class="text-red-400 font-bold font-mono">₹${parseFloat(u.bill_due).toLocaleString()}</span> <span class="text-[10px] text-red-500 uppercase font-bold ml-1">OVERDUE</span>`;

                return `
                <tr class="${rowClass} transition-colors border-b border-slate-800/50">
                    <td class="p-5">
                        <div class="flex flex-col">
                            <span class="font-bold text-white ${isBlocked ? 'text-red-300 line-through' : ''}">${u.email}</span>
                            <span class="text-[10px] text-slate-500 font-mono">UID: ${u.id}</span>
                        </div>
                    </td>
                    <td class="p-5">
                        <div class="flex flex-col">
                            <span class="text-white font-mono text-sm">${u.devices.length} Meters</span>
                            <span class="text-xs text-brand-400 font-bold">${parseFloat(u.total_units).toLocaleString()} Units</span>
                        </div>
                    </td>
                    <td class="p-5">${billDisplay}</td>
                    <td class="p-5">${statusBadge}</td>
                    <td class="p-5 text-right">
                        <div class="flex justify-end gap-2">
                            ${isBlocked 
                                ? `<button onclick="toggleBlock(${u.id}, false)" class="px-3 py-1.5 rounded bg-green-600 hover:bg-green-500 text-white text-xs font-bold uppercase shadow-lg shadow-green-900/20">Activate</button>`
                                : `<button onclick="toggleBlock(${u.id}, true)" class="px-3 py-1.5 rounded bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white border border-red-800 hover:border-red-500 text-xs font-bold uppercase transition-all">Suspend</button>`
                            }
                            <button onclick="deleteUser(${u.id})" class="p-2 text-slate-500 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        }

        function renderDeviceRegistry() {
            const tbody = document.getElementById('device-master-table');
            let html = '';
            
            allUsers.forEach(u => {
                u.devices.forEach(d => {
                    html += `
                        <tr class="hover:bg-slate-800/30 transition-colors border-b border-slate-800/50">
                            <td class="p-5 font-mono text-brand-400">${d}</td>
                            <td class="p-5">
                                <div class="flex flex-col">
                                    <span class="text-white font-medium">${u.email}</span>
                                    <span class="text-[10px] text-slate-500">ID: ${u.id}</span>
                                </div>
                            </td>
                            <td class="p-5"><span class="flex items-center gap-2 text-xs font-bold text-green-400"><span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ONLINE</span></td>
                            <td class="p-5 text-right">
                                <button onclick="deleteUser(${u.id})" class="text-red-400 hover:text-red-300 text-xs font-bold border border-red-500/30 px-2 py-1 rounded hover:bg-red-500/10">UNLINK</button>
                            </td>
                        </tr>`;
                });
            });

            if(html === '') html = '<tr><td colspan="5" class="p-8 text-center text-slate-500">No devices deployed yet.</td></tr>';
            tbody.innerHTML = html;
            lucide.createIcons();
        }

        // --- ACTIONS ---
        async function createUser() {
            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-pass').value;
            const token = localStorage.getItem('authToken');

            if(!email || !password) return showToast('Email and Password required', 'error');

            try {
                const res = await fetch(`${API_URL}/admin/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ email, password })
                });

                if(res.ok) {
                    showToast('Tenant onboarded successfully!');
                    loadUsers();
                    closeModal('modal-create-user');
                    document.getElementById('new-email').value = '';
                    document.getElementById('new-pass').value = '';
                } else {
                    const data = await res.json();
                    showToast(data.error, 'error');
                }
            } catch(e) { showToast('Connection Error', 'error'); }
        }

        async function assignDevice() {
            const userId = document.getElementById('assign-user-id').value;
            const deviceId = document.getElementById('assign-device-id').value;
            const name = document.getElementById('assign-device-name').value;
            const token = localStorage.getItem('authToken');

            if(!userId || !deviceId) return showToast('User ID & Device ID required', 'error');

            try {
                const res = await fetch(`${API_URL}/admin/assign-device`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ userId, deviceId, deviceName: name })
                });

                if(res.ok) {
                    showToast(`Device ${deviceId} assigned!`);
                    closeModal('modal-assign-device');
                    document.getElementById('assign-user-id').value = '';
                    document.getElementById('assign-device-id').value = '';
                    document.getElementById('assign-device-name').value = '';
                    loadUsers();
                } else {
                    const data = await res.json();
                    showToast(data.error, 'error');
                }
            } catch(e) { showToast('Connection Error', 'error'); }
        }

        async function deleteUser(id) {
            if(!confirm("⚠️ PERMANENT DELETE WARNING\n\nThis will wipe all data for this user. Continue?")) return;
            const token = localStorage.getItem('authToken');
            try {
                await fetch(`${API_URL}/admin/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showToast('User deleted permanently');
                loadUsers();
            } catch(e) { showToast('Delete failed', 'error'); }
        }

        async function toggleBlock(id, shouldBlock) {
            const action = shouldBlock ? "SUSPEND" : "ACTIVATE";
            if(!confirm(`Are you sure you want to ${action} this client?`)) return;
            const token = localStorage.getItem('authToken');
            
            try {
                const res = await fetch(`${API_URL}/admin/users/${id}/block`, { 
                   method: 'PUT', 
                   headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                   body: JSON.stringify({ blocked: shouldBlock })
                });
                
                if(res.ok) {
                    const user = allUsers.find(u => u.id === id);
                    if(user) user.is_blocked = shouldBlock;
                    renderUsers(allUsers);
                    showToast(shouldBlock ? "Client Suspended" : "Client Activated", shouldBlock ? 'error' : 'success');
                } else {
                    showToast("Failed to update status", 'error');
                }
            } catch(e) { 
                showToast('Action Failed', 'error');
            }
        }

        function showToast(msg, type='success') {
            const box = document.createElement('div');
            box.className = `p-4 rounded-xl border shadow-2xl flex items-center gap-3 animate-slide-in ${type==='success'?'bg-slate-900 border-green-500 text-green-400':'bg-red-950 border-red-500 text-red-200'}`;
            box.innerHTML = `<i data-lucide="${type==='success'?'check':'alert-triangle'}" class="w-5 h-5"></i> <span class="font-bold text-sm">${msg}</span>`;
            document.getElementById('toast-container').appendChild(box);
            lucide.createIcons();
            setTimeout(() => box.remove(), 3000);
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function logout() { localStorage.clear(); window.location.href='/login.html'; }

        // Initialize
        loadUsers();
        loadPendingRequests();
        lucide.createIcons();
    </script>
</body> 
</html>

